version: "3.8"

services:
  alimante:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: alimante-dev
    ports:
      - "8000:8000"
    environment:
      - ALIMANTE_SECRET_KEY=dev-secret-key-change-in-production
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_DEBUG=true
      - LOG_LEVEL=DEBUG
      - LOG_FILE=logs/alimante.log
      - GPIO_MODE=BCM
      - GPIO_WARNINGS=false
      - SENSOR_READ_INTERVAL=30
      - SENSOR_CALIBRATION_ENABLED=true
      - CORS_ORIGINS=http://localhost:3000,http://192.168.1.100:3000
      - MAX_LOGIN_ATTEMPTS=5
      - SESSION_TIMEOUT_MINUTES=30
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
      - ./data:/app/data
      - /dev/gpiomem:/dev/gpiomem:rw
      - /sys/class/gpio:/sys/class/gpio:rw
    devices:
      - /dev/gpiomem:/dev/gpiomem
      - /sys/class/gpio:/sys/class/gpio
    restart: unless-stopped
    networks:
      - alimante-network

  alimante-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: alimante-test
    environment:
      - ALIMANTE_SECRET_KEY=test-secret-key
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_DEBUG=true
      - LOG_LEVEL=DEBUG
      - GPIO_MODE=BCM
      - GPIO_WARNINGS=false
    volumes:
      - ./tests:/app/tests
      - ./src:/app/src
      - ./logs:/app/logs
    command: pytest tests/ -v --tb=short
    networks:
      - alimante-network

networks:
  alimante-network:
    driver: bridge

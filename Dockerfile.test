# Dockerfile pour les tests Alimante
# Basé sur Python 3.11 slim pour optimiser la taille

FROM python:3.11-slim

# Métadonnées
LABEL maintainer="Alimante Team <contact@alimante.com>"
LABEL description="Tests pour le système de gestion automatisée des mantes"
LABEL version="1.0.0"

# Variables d'environnement
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Installation des dépendances système
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libffi-dev \
    libssl-dev \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Création de l'utilisateur non-root
RUN groupadd -r alimante && useradd -r -g alimante alimante

# Création des répertoires de travail
WORKDIR /app

# Copie des fichiers de dépendances
COPY requirements.txt pyproject.toml setup.py ./

# Installation des dépendances Python
RUN pip install --no-cache-dir --upgrade pip setuptools wheel
RUN pip install --no-cache-dir -r requirements.txt

# Installation des dépendances de développement
RUN pip install --no-cache-dir pytest pytest-mock pytest-asyncio pytest-cov

# Copie du code source
COPY . .

# Installation du package en mode développement
RUN pip install -e .

# Création des répertoires nécessaires
RUN mkdir -p logs data config/backups

# Changement des permissions
RUN chown -R alimante:alimante /app

# Passage à l'utilisateur non-root
USER alimante

# Point d'entrée par défaut (tests)
CMD ["pytest", "tests/", "-v", "--tb=short"]
